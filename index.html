<!DOCTYPE html>
  <head>
    <title>OBS CR control</title>

    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>

    <style>
        .indicator {
            user-select: none
        }
    </style>

  </head>
  <body>

    <div id="ssl-warning" style="display:none; color: maroon">You are currently using
    HTTPS.  Unfortunately OBS probably isn't using SSL and browsers
    only allow SSL websocket connections from SSL pages, so you need
    to turn SSL off.  Please try changing the URL to 'http' instead of
    'https' which might require telling your browser to not force SSL for this
    page (firefox: click around the page icon).</div>

    <div id="audio-warning" style="display:none; color: maroon">Audio
    playback has failed.  Do you need to allow it on this page?
    Reload the page when done.</div>

    <div id="status">Status is updated here</div>

    <table border="1">
      <tr><td class="indicator indicator-warning">Warn</td>
          <td class="indicator indicator-caution">Caution</td></tr>
      <tr><td class="indicator indicator-time">Time</td>
          <td class="indicator indicator-notes">Notes</td></tr>
      <tr><td class="indicator indicator-question">Question</td>
          <td class="indicator indicator-chat">Chat</td></tr>
      <tr><td class="indicator indicator-slower">Slower</td>
          <td class="indicator indicator-faster">Faster</td></tr>
    </table>

    <script>
      SOUNDS = {
	  'low': '311.wav',
	  'high': '349.wav',
	  'alert-high': '622.wav',
	  'alert-medium': '440.wav',
	  'alert-low': '261.wav',
      }
      SOUNDFILES = { }
      INDICATORS = {
	  'indicator-warning': 'red',
	  'indicator-caution': 'yellow',
	  'indicator-time': 'yellow',
	  'indicator-notes': 'cyan',
	  'indicator-question': 'cyan',
	  'indicator-chat': 'cyan',
	  'indicator-slower': 'yellow',
	  'indicator-faster': 'yellow',
      }

      // If this is SSL, show the warning
      if (window.location.protocol === 'https:') {
	  document.getElementById('ssl-warning').style.display = 'block';
      }

      // Convert key=value&key2=value2 in URL fragment to dict
      function getFragmentParams() {
          const params = {};
          const fragment = window.location.hash.substring(1);
          const pairs = fragment.split('&');
          pairs.forEach(pair => {
              const [key, value] = pair.split('=');
              if (key) {
                  params[decodeURIComponent(key)] = decodeURIComponent(value || '');
              }
          });
          return params;
      }

      function update_status(text) {
        document.getElementById('status').innerText = text;

      }

      function soundEvent(value) {
        //console.log(`sound event: ${value}`);
            update_status(`Sound event: ${value}`);
        filename = SOUNDS[value];

        if (value in SOUNDFILES) {
            SOUNDFILES[filename].play();
        }
        else {
            console.log(`Loading ./obs_cr/sound/${filename}`)
                const audio = new Audio(`./obs_cr/sound/${filename}`);
            //console.log(audio);
            SOUNDFILES[filename] = audio;
            audio.play().catch((error) => {
                // Handle the error
                console.error('Error playing audio:', error);
                document.getElementById('audio-warning').style.display = 'block';
            });
        }
      }

      const params = getFragmentParams();
      const url = params.url || 'localhost:4455';
      const password = params.password || '';

      // Create a new OBS WebSocket instance
      const obs = new OBSWebSocket();


      // Set a value (and broadcast an event that represents it)
      async function obs_set(name, value) {
        x = await obs.call("SetPersistentData", {
                                realm: "OBS_WEBSOCKET_DATA_REALM_PROFILE", 
                                slotName: name,
                                slotValue: value});
        await obs.call('BroadcastCustomEvent', {eventData: {[name]: value}});
      };
      // Get a value
      async function obs_get(name) {
        x = await obs.call("GetPersistentData", {
                                realm: "OBS_WEBSOCKET_DATA_REALM_PROFILE", 
                                slotName: name});
        return(x.slotValue);
      };
      WATCHERS = { };
      function obs_watch(name, callback) {
        if (WATCHERS[name] === undefined) {
            WATCHERS[name] = [];
        }
        WATCHERS[name].push(callback);
      };
      function _obs_on_custom_event (data) {
        //console.log('a');
        for (name in data) {
            //console.log('b', name);
            if (WATCHERS[name] !== undefined) {
                //console.log('c', name, data[name]);
                for (func of WATCHERS[name].values()) {
                    console.log('d', name, data[name], func);
                    func(data[name]);
                }
            }
        }
      };


      console.log("Trying to connect to", `ws://${url} pass ${password}`)
      obs.connect(`ws://${url}`, password)
        .then(() => {
            update_status('Connected to OBS WebSocket!');
            obs.on('CustomEvent', _obs_on_custom_event);
        })
    .catch(err => {
        update_status(`Connection failed: ${err.message}`);
    });


    function indicatorUpdate(name, state) {
        console.log('aaaa', name, state);
        cells = document.getElementsByClassName(name);
        for (c of cells) {
            c.style.backgroundColor = state ? INDICATORS[name] : '';
        }
    }

	function indicatorClick(event) {
        cell = event.target;
        class_ = cell.classList[cell.classList.length-1];
        console.log('a', "Click on", cell, class_, "newstate=", !cell.style.backgroundColor);
        new_state = !cell.style.backgroundColor
        obs_set(class_, new_state);
        if (new_state) {
            if (INDICATORS[class_] === 'red')    {obs_set('playsound', 'alert-high')};
            if (INDICATORS[class_] === 'yellow') {obs_set('playsound', 'alert-medium')};
            if (INDICATORS[class_] === 'cyan')   {obs_set('playsound', 'alert-low')};
        }
	}

	cells = document.querySelectorAll('.indicator');
    cells.forEach(cell => {
        class_ = cell.classList[cell.classList.length-1];
        console.log(class_);
        cell.addEventListener('click', indicatorClick);
        obs_watch(class_, function(state) {indicatorUpdate(class_, state);});
    }
    );

    obs_watch('playsound', soundEvent);

    </script>

  <body>
  </html>
