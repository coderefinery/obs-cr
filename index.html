<!DOCTYPE html>
  <head>
    <title>OBS CR control</title>

    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>

  </head>
  <body>

    <div id="ssl-warning" style="display:none; color: maroon">You are currently using
    HTTPS.  Unfortunately OBS probably isn't using SSL and thus your
    web browser won't connect.  Please disable SSL for this page and
    try again.</div>

    <div id="audio-warning" style="display:none; color: maroon">Audio
    playback has failed.  Do you need to allow it on this page?
    Reload the page when done.</div>

    <div id="status">Status is updated here</div>

    <table border="1">
      <tr><td class="indicator-warning">Warn</td></tr>
      <tr><td class="indicator-caution">Caution</td></tr>
      <tr><td class="indicator-time">Time</td></tr>
      <tr><td class="indicator-notes">Notes</td></tr>
      <tr><td class="indicator-question">Question</td></tr>
      <tr><td class="indicator-chat">Chat</td></tr>
      <tr><td class="indicator-slower">Slower</td></tr>
      <tr><td class="indicator-faster">Faster</td></tr>
    </table>

    <script>
      SOUNDS = {
	  'low': '311.wav',
	  'high': '349.wav',
	  'alert-high': '622.wav',
	  'alert-medium': '440.wav',
	  'alert-low': '261.wav',
      }
      SOUNDFILES = { }
      INDICATORS = {
	  'indicator-warning': 'red',
	  'indicator-caution': 'yellow',
	  'indicator-time': 'yellow',
	  'indicator-notes': 'cyan',
	  'indicator-question': 'cyan',
	  'indicator-chat': 'cyan',
	  'indicator-slower': 'yellow',
	  'indicator-faster': 'yellow',
      }

      // If this is SSL, show the warning
      if (window.location.protocol === 'https:') {
	  document.getElementById('ssl-warning').style.display = 'block';
      }

      // Convert key=value&key2=value2 in URL fragment to dict
      function getFragmentParams() {
          const params = {};
          const fragment = window.location.hash.substring(1);
          const pairs = fragment.split('&');
          pairs.forEach(pair => {
              const [key, value] = pair.split('=');
              if (key) {
                  params[decodeURIComponent(key)] = decodeURIComponent(value || '');
              }
          });
          return params;
      }

      function soundEvent(value) {
	  //console.log(`sound event: ${value}`);
          document.getElementById('status').innerText = `Sound event: ${value}`;
	  filename = SOUNDS[value];

	  if (value in SOUNDFILES) {
	      SOUNDFILES[filename].play();
	  }
	  else {
	      console.log(`Loading ./obs_cr/sound/${filename}`)
              const audio = new Audio(`./obs_cr/sound/${filename}`);
	      //console.log(audio);
	      SOUNDFILES[filename] = audio;
	      audio.play().catch((error) => {
                // Handle the error
                console.error('Error playing audio:', error);
                document.getElementById('audio-warning').style.display = 'block';
            });
	  }

      }

      const params = getFragmentParams();
      const url = params.url || 'localhost:4455';
      const password = params.password || '';

      // Create a new OBS WebSocket instance
      const obs = new OBSWebSocket();

      console.log("Trying to connect to", `ws://${url} pass ${password}`)
      obs.connect(`ws://${url}`, password)
        .then(() => {
            document.getElementById('status').innerText = 'Connected to OBS WebSocket!';

	    // Listen for custom events
            obs.on('CustomEvent', (data) => {
		console.log(data);
		if ('playsound' in data) {
		    soundEvent(data.playsound);
		}

		for (indicator in INDICATORS) {
		    if (indicator in data) {
			state = data[indicator];
			console.log(indicator, state);
			cells = document.getElementsByClassName(indicator);
			for (c of cells) {
			    c.style.backgroundColor = state ? INDICATORS[indicator] : '';
			}
		    }
		}
            })
        })
    .catch(err => {
        document.getElementById('status').innerText = `Connection failed: ${err.message}`;
    });



    </script>

  <body>
  </html>
