<!DOCTYPE html>
  <head>
    <title>OBS CR control</title>

    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="util.js"></script>
    <script src="control.js"></script>
    <script type="module">
        //Load global YAML config.  This is loaded too late to be
        // used to layout the HTML but can be used for other things.
        fetch("config.yaml").then(response => {
            response.text().then( text => {
                globalThis.CONFIG = jsyaml.load(text)
            })
        })
    </script>

    <style>
        .scene, .indicator {
            user-select: none
        }
    </style>

  </head>
  <body>

    <div id="ssl-warning" style="display:none; color: maroon">You are currently using
    HTTPS.  Unfortunately OBS probably isn't using SSL and browsers
    only allow SSL websocket connections from SSL pages, so you need
    to turn SSL off.  Please try changing the URL to 'http' instead of
    'https' which might require telling your browser to not force SSL for this
    page (firefox: click around the page icon).</div>

    <div id="audio-warning" style="display:none; color: maroon">Audio
    playback has failed.  Do you need to allow it on this page?
    Reload the page when done.</div>

    <div id="status">Status is updated here</div>

    <table border="1">
        <tr><td class="live" title="When red, may be visible">Live</td>
            <!--<td class="live-mic">Caution</td>--></tr>
      </table>

    <table border="1">
      <tr><td class="indicator indicator-warning" title="Generalized 'something urgent has come up'">Warn</td>
          <td class="indicator indicator-caution" title="Generalized 'something to look at' has come up">Caution</td></tr>
      <tr><td class="indicator indicator-time">Time</td>
          <td class="indicator indicator-notes">Notes</td></tr>
      <tr><td class="indicator indicator-question">Question</td>
          <td class="indicator indicator-chat">Chat</td></tr>
      <tr><td class="indicator indicator-slower">Slower</td>
          <td class="indicator indicator-faster">Faster</td></tr>
    </table>

    <table border="1">
        <tr>
            <th>Scene selection</th>
            <td class="scene" id="Title" livecolor="orange">Title</td>
            <td class="scene" id="Gallery">Gallery</td>
            <td class="scene" id="Screenshare">SS Portrait</td>
            <td class="scene" id="ScreenshareCrop">SS Crop</td>
            <td class="scene" id="ScreenshareLandscape">SS Landscape</td>
            <td class="scene" id="BroadcasterScreen">BrdScr</td>
            <td class="scene" id="Notes" livecolor="orange">Notes</td>
            <td class="scene" id="Empty" livecolor="orange">Empty</td>
        </tr>
    </table>

    <table border="1">
        <tr>
            <td><button class="preset-label"  id="preset-a"></button></td>
            <td><select class="preset-sbox"   id="preset-a"></select></td>
            <td><select class="preset-rbox"   id="preset-a"></select></td>
            <td><button class="preset-rename" id="preset-a">r</button></td>
        </tr>
    </table>

    <table border="1">
        <tr>
            <td class="mute" id="BroadcasterMic">Brcd</td>
            <td class="mute" id="Instructors">Instr</td>
            <td><input class="volume" id="Instructors" type="range" min="-2" max="0" step="0.05"></td>
            <td><span class="volume-dB" id="Instructors"></span></td>
        </tr>
    </table>
    <table border="1">
        <tr>
            <th>Gallery size</th>
            <td colspan="4"><input class="gallerysize" type="range" min="0" max="1" step="0.01"></td>
            <td><span class="gallerysize-state"></span></td>
        </tr>
        <tr>
            <th>Gallery crop</th>
            <td class="gallerycrop" id="0">None</td>
            <td class="gallerycrop" id="1">n=1</td>
            <td class="gallerycrop" id="2">n=2</td>
            <td class="gallerycrop" id="3">n=3-4</td>
            <td class="gallerycrop" id="5">n=5-6</td>
        </tr>
    </table>


    <a id="preview-href" herf="">Real-time scene preview</a>

    <script>
      NOTES = "Notes"
      GALLERY = "ZoomGalleryCapture"
      SCENES_WITH_RESIZEABLE_GALLERY = ["Screenshare", "ScreenshareCrop", "ScreenshareLandscape", "BroadcasterScreen", "Notes"]
      SCENES = ["Title", "Gallery", ...SCENES_WITH_RESIZEABLE_GALLERY, "Empty"]
      SCENES_SAFE = ["Title", "Notes", "Empty"]
      SOUNDS = {
	  'low': '311.wav',
	  'high': '349.wav',
	  'alert-high': '622.wav',
	  'alert-medium': '440.wav',
	  'alert-low': '261.wav',
      }
      SOUNDFILES = { }
      INDICATORS = {
	  'indicator-warning': 'red',
	  'indicator-caution': 'yellow',
	  'indicator-time': 'yellow',
	  'indicator-notes': 'cyan',
	  'indicator-question': 'cyan',
	  'indicator-chat': 'cyan',
	  'indicator-slower': 'yellow',
	  'indicator-faster': 'yellow',
      }

      purl = new URL(window.location.href);
      purl.pathname = purl.pathname.replace(/\/[^\/]*?$/, '/preview.html')
      document.getElementById('preview-href').href = purl.toString();


      function soundEvent(value) {
        //console.log(`sound event: ${value}`);
            update_status(`Sound event: ${value}`);
        filename = SOUNDS[value];

        if (value in SOUNDFILES) {
            SOUNDFILES[filename].play();
        }
        else {
            console.log(`Loading ./sound/${filename}`)
                const audio = new Audio(`./sound/${filename}`);
            //console.log(audio);
            SOUNDFILES[filename] = audio;
            audio.play().catch((error) => {
                // Handle the error
                console.error('Error playing audio:', error);
                document.getElementById('audio-warning').style.display = 'block';
            });
        }
      }

      const params = getFragmentParams();
      const url = params.url || 'localhost:4455';
      const password = params.password || '';

      // Create a new OBS WebSocket instance
      const obs = new OBSWebSocket();

      update_status("Trying to connect to", `ws://${url}`)

      function load_config () {
      return fetch("config.yaml").then(response => {
            response.text().then( text => {
                globalThis.CONFIG = jsyaml.load(text)
            })
        })
      }

      function obs_init () {
        update_status(`Connected to OBS at ws://${url}.`);
            _obs_init_watchers(obs)
            obs_watch('playsound', soundEvent);

            init_indicators(obs)
            init_live(obs)
            init_scene(obs)
            init_mute(obs)
            init_volume(obs)
            init_gallery(obs)
            init_preset(obs)

            // Poll to keep the connection alive
            setInterval(async function() {console.log("Connection ping: ", (await obs.call('GetVersion')).obsVersion)},
                        60000);

            obs.on('ConnectionClosed', e => { update_status(`OBS Disconnected (closed)!: ${e}`); } )
            obs.on('ConnectionError', e => { update_status(`OBS Disconnected (error)!: ${e}`); } )
      }

      load_config().then(() => {
        obs.connect(`ws://${url}`, password)
        .then(() => {
            obs_init()
        })
        .catch(err => {
            update_status(`Connection failed: ${err.message}`);
        });
      })


    </script>

  <body>
  </html>
