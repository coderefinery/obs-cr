<!DOCTYPE html>
  <head>
    <title>OBS CR control</title>

    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="util.js"></script>
    <script src="control.js"></script>
    <script type="module">
        //Load global YAML config.  This is loaded too late to be
        // used to layout the HTML but can be used for other things.
        //fetch("config.yaml").then(response => {
        //    response.text().then( text => {
        //        globalThis.CONFIG = jsyaml.load(text)
        //    })
        //})
    </script>

    <style>
        .scene, .indicator {
            user-select: none
        }
    </style>

  </head>
  <body>

    <div class="ssl-warning" style="display:none; color: maroon">You are currently using
    HTTPS.  Unfortunately OBS probably isn't using SSL and browsers
    only allow SSL websocket connections from SSL pages, so you need
    to turn SSL off.  Please try changing the URL to 'http' instead of
    'https' which might require telling your browser to not force SSL for this
    page (firefox: click around the page icon).</div>

    <div class="audio-warning" style="display:none; color: maroon">Audio
    playback has failed.  Do you need to allow it on this page?
    Reload the page when done.</div>

    <div class="status">Status is updated here</div>
    <span class="synced" syncwith="scene">Scene</span>
    <span class="synced" syncwith="ss_resolution">Resolution</span>


    <table border="1">
      <tr><th>Indicators:</th>
          <td class="live" title="When red, (audio, camera gallery, or screenshare) may be being broadcasted">Live</td>
          <td><button class="indicator indicator-warning" title="Generalized 'something urgent has come up'">Warn</button></td>
          <td><button class="indicator indicator-caution" title="Generalized 'something to look at' has come up">Caution</button></td>
          <td><button class="indicator indicator-time" title="Take a look at the clock">Time</button></td>
          <td><button class="indicator indicator-notes" title="Check the notes: something has come up">Notes</button></td>
          <td><button class="indicator indicator-question" title="Your co-teacher has a question">Question</button></td>
          <td><button class="indicator indicator-chat" title="Check the Zulip chat: something has come up">Chat</button></td>
          <td><button class="indicator indicator-slower" title="Try to speak at a slower pace">Slower</button></td>
          <td><button class="indicator indicator-faster" title="Try to speak at a faster pace">Faster</button></td></tr>
    </table>

    <table border="1">
        <tr>
            <th>Quick actions:</th>
            <td><button class="quick-break">Break</button></td>
            <td></td>
            <td><button class="quick-back">Back to â†’</button></td>
            <td><select class="quick-back-scene synced" syncwith="quickback-quickback-a-value"></select></td>
            <td><input class="quick-back-audio-brcd synced" type="checkbox" syncwith="checkbutton-quick_brcd-value">Brcd Audio?</input></td>
            <td><input class="quick-back-jingle synced" type="checkbox" disabled="true" syncwith="checkbutton-quick_jingle-value">Jingle?</input></td>
        </tr>
    </table>

    <table border="1">
        <tr>
            <th>Scene selection</th>
            <td><button class="scene" id="Title" livecolor="orange">Title</button></td>
            <td><button class="scene" id="Gallery">Gallery</button></td>
            <td><button class="scene" id="Screenshare">SS Portrait</button></td>
            <td><button class="scene" id="ScreenshareCrop">SS Crop</button></td>
            <td><button class="scene" id="ScreenshareLandscape">SS Landscape</button></td>
            <td><button class="scene" id="BroadcasterScreen">BrdScr</button></td>
            <td><button class="scene" id="Notes" livecolor="orange">Notes</button></td>
            <td><button class="scene" id="Empty" livecolor="orange">Empty</button></td>
        </tr>
    </table>

    <table border="1">
        <tr>
            <td rowspan="3">Scene presets:</td>
            <td><button class="preset-go"           id="preset-a">Go</button></td>
            <!--<td><button class="preset-label synced" id="preset-a" syncwith="preset-preset-a-label">A</button></td>-->
            <td><input  class="preset-label synced" id="preset-a" type="text" syncwith="preset-preset-a-label" value="A" size="10"></td>
            <td><select class="preset-sbox synced"  id="preset-a" syncwith="preset-preset-a-sbox"></select></td>
            <td><select class="preset-rbox synced"  id="preset-a" syncwith="preset-preset-a-rbox"></select></td>
            <!--<td><button class="preset-rename"       id="preset-a">r</button></td>-->
            <td>&nbsp&nbsp</td>
            <td><button class="preset-go"           id="preset-b">Go</button></td>
            <td><input  class="preset-label synced" id="preset-b" type="text" syncwith="preset-preset-b-label" value="B" size="10"></td>
            <td><select class="preset-sbox synced"  id="preset-b" syncwith="preset-preset-b-sbox"></select></td>
            <td><select class="preset-rbox synced"  id="preset-b" syncwith="preset-preset-b-rbox"></select></td>
        </tr>
        <tr>
            <td><button class="preset-go"           id="preset-c">Go</button></td>
            <td><input  class="preset-label synced" id="preset-c" type="text" syncwith="preset-preset-c-label" value="C" size="10"></td>
            <td><select class="preset-sbox synced"  id="preset-c" syncwith="preset-preset-c-sbox"></select></td>
            <td><select class="preset-rbox synced"  id="preset-c" syncwith="preset-preset-c-rbox"></select></td>
            <td></td>
            <td><button class="preset-go"           id="preset-d">Go</button></td>
            <td><input  class="preset-label synced" id="preset-d" type="text" syncwith="preset-preset-d-label" value="D" size="10"></td>
            <td><select class="preset-sbox synced"  id="preset-d" syncwith="preset-preset-d-sbox"></select></td>
            <td><select class="preset-rbox synced"  id="preset-d" syncwith="preset-preset-d-rbox"></select></td>
        </tr>
        <tr>
            <td><button class="preset-go"           id="preset-e">Go</button></td>
            <td><input  class="preset-label synced" id="preset-e" type="text" syncwith="preset-preset-e-label" value="E" size="10"></td>
            <td><select class="preset-sbox synced"  id="preset-e" syncwith="preset-preset-e-sbox"></select></td>
            <td><select class="preset-rbox synced"  id="preset-e" syncwith="preset-preset-e-rbox"></select></td>
            <td></td>
            <td><button class="preset-go"           id="preset-f">Go</button></td>
            <td><input  class="preset-label synced" id="preset-f" type="text" syncwith="preset-preset-f-label" value="F" size="10"></td>
            <td><select class="preset-sbox synced"  id="preset-f" syncwith="preset-preset-f-sbox"></select></td>
            <td><select class="preset-rbox synced"  id="preset-f" syncwith="preset-preset-f-rbox"></select></td>
        </tr>
    </table>

    <table border="1">
        <tr>
            <th>Audio:</th>
            <td><button class="mute" id="BroadcasterMic">Brcd</button></td>
            <td><button class="mute" id="Instructors">Instr</button></td>
            <td><input class="volume" id="Instructors" type="range" min="-2" max="0" step="0.05"></td>
            <td><span class="volume-dB" id="Instructors"></span></td>
        </tr>
    </table>
    <table border="1">
        <tr>
            <th>Gallery size:</th>
            <td colspan="4"><input class="gallerysize" type="range" min="0" max="1" step="0.01"></td>
            <td><span class="gallerysize-state"></span></td>
        </tr>
        <tr>
            <th>Gallery crop:</th>
            <td><button class="gallerycrop" id="n0">None</button></td>
            <td><button class="gallerycrop" id="n1">n=1</button></td>
            <td><button class="gallerycrop" id="n2">n=2</button></td>
            <td><button class="gallerycrop" id="n3">n=3-4</button></td>
            <td><button class="gallerycrop" id="n5">n=5-6</button></td>
        </tr>
    </table>
    <table border="p">
        <tr>
            <th>Notes scroll:</th>
            <td><button class="scrollnotes up"  >Up  </button></td>
            <td><button class="scrollnotes down">Down</button></td>
            <td><button class="scrollnotes pgup">PgUp</button></td>
            <td><button class="scrollnotes pgdn">PgDn</button></td>
            <td><button class="scrollnotes end" >End </button></td>
        </tr>
    </table>


    <a class="preview-href" herf="">Real-time scene preview</a>

    <script>
      NOTES = "Notes"
      GALLERY = "ZoomGalleryCapture"
      SCENES_WITH_RESIZEABLE_GALLERY = ["Screenshare", "ScreenshareCrop", "ScreenshareLandscape", "BroadcasterScreen", "Notes"]
      SCENES = ["Title", "Gallery", ...SCENES_WITH_RESIZEABLE_GALLERY, "Empty"]
      SCENES_SAFE = ["Title", "Notes", "Empty"]
      SOUNDS = {
	  'low': '311.wav',
	  'high': '349.wav',
	  'alert-high': '622.wav',
	  'alert-medium': '440.wav',
	  'alert-low': '261.wav',
      }
      SOUNDFILES = { }
      INDICATORS = {
	  'indicator-warning': 'red',
	  'indicator-caution': 'yellow',
	  'indicator-time': 'yellow',
	  'indicator-notes': 'cyan',
	  'indicator-question': 'cyan',
	  'indicator-chat': 'cyan',
	  'indicator-slower': 'yellow',
	  'indicator-faster': 'yellow',
      }

      purl = new URL(window.location.href);
      purl.pathname = purl.pathname.replace(/\/[^\/]*?$/, '/preview.html')
      forEach('.preview-href', x => {x.href = purl.toString()});


      function soundEvent(value) {
        //console.log(`sound event: ${value}`);
            update_status(`Sound event: ${value}`);
        filename = SOUNDS[value];

        if (value in SOUNDFILES) {
            SOUNDFILES[filename].play();
        }
        else {
            console.log(`Loading ./sound/${filename}`)
                const audio = new Audio(`./sound/${filename}`);
            //console.log(audio);
            SOUNDFILES[filename] = audio;
            audio.play().catch((error) => {
                // Handle the error
                console.error('Error playing audio:', error);
                forEach('.audio-warning', x => {x.style.display = 'block'});
            });
        }
      }

      const params = getFragmentParams();
      const url = params.url || 'localhost:4455';
      const password = params.password || '';

      // Create a new OBS WebSocket instance
      const obs = new OBSWebSocket();

      update_status(`Trying to connect to ws://${url}`)

      function load_config () {
        return fetch("config.yaml").then(response => {
            response.text().then( text => {
                CONFIG = jsyaml.load(text)
                globalThis.CONFIG = CONFIG
                // Make mapping human name -> scene names
                CONFIG.SCENES_REVERSE = { }
                for (scene in CONFIG.SCENES) {
                    CONFIG.SCENES_REVERSE[CONFIG.SCENES[scene].name]= scene
                }
            })
        })
      }

      async function obs_init () {
        update_status(`Connected to OBS at ws://${url}.`);
            _obs_init_watchers(obs)
            obs_watch('playsound', soundEvent);

            await init_sync_checkboxes(obs)
            await init_sync_selects(obs)
            await init_sync_textcontent(obs)
            await init_sync_input(obs)
            init_live(obs)
            init_indicators(obs)
            init_scene(obs)
            init_mute(obs)
            init_volume(obs)
            init_gallery(obs)
            init_preset(obs)
            init_quick(obs)
            init_scrollnotes(obs)

            // Poll to keep the connection alive
            setInterval(async function() {console.log("Connection ping: ", (await obs.call('GetVersion')).obsVersion)},
                        60000);

            obs.on('ConnectionClosed', e => { update_status(`OBS Disconnected (closed)!: ${e}`); } )
            obs.on('ConnectionError', e => { update_status(`OBS Disconnected (error)!: ${e}`); } )
      }

      load_config().then(() => {
        obs.connect(`ws://${url}`, password)
        .then(() => {
            obs_init()
        })
        .catch(err => {
            update_status(`Connection failed: ${err.message}`);
        });
      })


    </script>

  <body>
  </html>
